<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <title>用户信息</title>
    <link href="../../style/bootstrap.min.css" rel="stylesheet" />
    <script src="../../js/jquery.min.js"></script>
    <script src="../../js/url_zhuan.js"></script>
    <link href="../../style/animate.css" rel="stylesheet" />
    
    <link href="../../style/validationEngine.jquery.css" rel="stylesheet" />
    <link href="../../style/Form.css" rel="stylesheet" />
    <script src="../../js/jquery.form.js" type="text/javascript"></script>
    <script src="../../js/FTool.js" type="text/javascript"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=vTZYBA0KBc1ebqpeEpftrWuVEo5RZXli"></script>

    <script type="text/javascript">
        function checkHELLO(field, rules, i, options) {
            if (!/^(13[0-9]|14[0-9]|15[0-9]|16[0-9]|17[0-9]|18[0-9]|19[0-9])\d{8}$/i.test(field.val())) {
                return "请输入有效的手机号码";
            }
        }
    </script>


    <link href="../../style/MDForm.css" rel="stylesheet" />

</head>

<body>
    <div class="bodyBox">

        <form action="" class="form-horizontal" id="editForm" method="post">
            <div class="formBody" id="formBody">
                <!--//readonly='readonly'  只读-->
                <div class="form-group">
                    <label class="control-label col-xs-3 " for="ComName">项目名称</label>
                    <div class="col-xs-9">

                        <input class="form-control  " id="ComName" name="ComName" type="text" value="" />
                        <input id="ComID" name="ComID" type="hidden" value="013706" />
                        <input id="ComType" name="ComType" type="hidden" value="Area" />
                        <span
                                style="position: absolute;top: 0px;right: 39px;line-height: 34px;width: 45px;text-align: center;border:none;border-radius: 10px;background:#3cf;color:#fff"
                                id="r-result">查询</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-xs-3 " for="address">项目位置</label>
                    <div class="col-xs-9">
                        <input class="form-control" id="address" name="address" type="text" value="" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-xs-3 " for="UserName">防火员</label>
                    <div class="col-xs-9">
                        <input class="form-control " id="UserName" name="UserName" type="text" value="" />
                    </div>
                </div>
                <div style="width:100%;height:250px;" class="fangText">

                </div>
                <div class="form-group">
                    <label class="control-label col-xs-3 " for="ResPeople">负责人</label>
                    <div class="col-xs-9">
                        <input class="form-control" id="ResPeople" name="ResPeople" type="text" value="" />
                    </div>
                </div>
                <div style="width:100%;height:250px;" class="renText">

                </div>
                <div class="form-group">
                    <label class="control-label col-xs-3 " for="wangPeople">网格员</label>
                    <div class="col-xs-9">
                        <input class="form-control" id="wangPeople" name="wangPeople" type="text" value="" />
                    </div>
                </div>
                <div style="width:100%;height:250px;" class="WangText">

                </div>
                <div class="form-group">
                    <label class="control-label col-xs-3 " for="StreePeople">街道负责人</label>
                    <div class="col-xs-9">
                        <input class="form-control" id="StreePeople" name="StreePeople" type="text" value="" />
                    </div>
                </div>
                <div style="width:100%;height:250px;" class="StreeText">

                </div>
                <div class="form-group">
                    <label class="control-label col-xs-3 " for="Intro">介绍</label>
                    <div class="col-xs-9">
                        <input class="form-control " readonly='readonly' id="Intro" name="Intro" type="text" value="" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-xs-3 " for="State">说明</label>
                    <div class="col-xs-9">
                        <input class="form-control " readonly='readonly' id="State" name="State" type="text" value="" />
                    </div>
                </div>
                <div class="form-group">
                    <div id="allmap" style="height:300px;"></div>
                </div>

            </div>
            <div class="formBut">
                <div class="form-group">
                    <div style="float:right;margin-right:30px;"> <input class="btn btn-primary" name="submitBtn"
                            type="button" value="保存" id="Edit_save" /> <input class="btn btn-default" name="goBackBtn"
                            type="button" value="关闭" id="btn_close" /> </div>
                    <div class="checkbox" style="float:right;margin-right:30px;"> <label>
                            <input data-val="true" data-val-number="字段 GUID 必须是一个数字。" id="ID" name="ID" type="hidden"
                                value="" />
                    </div>
        </form>
    </div>
    <!--<script src="../../js/jquery.validationEngine-zh.js"></script>
        <script src="../../js/jquery.validationEngine.js"></script>-->
    <script src="../../js/bootstrap.min.js"></script>
    <script>
        var global = (function () {
            var search = $('#ediModelIfm').context.URL;
            var search = decodeURI(search);
            var global = {};
            if (search != "") {
                search.slice(1).split('?')[1].split('&').forEach(
                    function (val) {
                        var arr = val.split("=");
                        global[arr[0]] = arr[1];
                    }
                );
            }
            return global;
        })();
        console.log(global);


        //http://112.74.126.51/earlyWarn/getLegalFireMan.action?&object=

        var html = "";
        html =
            "<div class='form-group'><label class='control-label col-xs-3 ' for='ComName'>项目名称</label><div class='col-xs-9'><input class='form-control  ' id='ComName' name='ComName' type='text' value='" +
            global.uName +
            "' /><input id='ComID' name='ComID'  type='hidden' value='' /><input id='ComType' name='ComType' type='hidden' value='Area' /></div></div><div class='form-group'><label class='control-label col-xs-3 ' for='address'>项目位置</label><div class='col-xs-9'><input class='form-control' id='address' name='address' type='text' value='" +
            global.uAddress +
            "' /><span style='position: absolute;top: 0px;right: 39px;line-height: 34px;width: 45px;text-align: center;border:none;border-radius: 10px;background:#3cf;color:#fff' id='r-result'>查询</span><input id='provincial_num' name='' type='hidden' value='' /></div></div><div class='form-group'><label class='control-label col-xs-3 ' for='UserName'>防火员和防火员电话</label><div class='col-xs-9'><input class='form-control allList ' data-val='0'  id='UserName' name='UserName' type='text' value='" +
            global.uUser + global.uUserTel +
            "' /></div><div style='width:100%;height:250px;overflow-y:auto;display:none;' class='fangText inputLable' data-val='0'></div></div><div class='form-group'><label class='control-label col-xs-3 ' for='ResPeople'>负责人和负责人电话</label><div class='col-xs-9'><input class='form-control allList' data-val='1' id='ResPeople' name='ResPeople' type='text' value='" +
            global.uRes + global.uResTel +
            "' /></div></div><div style='width:100%;height:250px;overflow-y:auto;display:none;' class='renText inputLable' data-val='1'></div><div class='form-group'><label class='control-label col-xs-3 ' for='gridmanname'>网格员和网格员电话</label><div class='col-xs-9'><input class='form-control allList' data-val='2' id='gridmanname' name='gridmanname' type='text' value='" +(global.gridmanname=='0'?' ':global.gridmanname +global.gridman) +"' /></div></div><div style='width:100%;height:250px;overflow-y:auto;display:none;' class='wangText inputLable' data-val='2'></div><div class='form-group'><label class='control-label col-xs-3 ' for='streetCharge'>街道负责人和街道负责人电话</label><div class='col-xs-9'><input class='form-control allList'  id='streetCharge' data-val='3' name='streetCharge' type='text' value='" +(global.streetCharge=='0'?' ':global.streetChargenanem + global.streetCharge) +"' /></div></div><div style='width:100%;height:250px;overflow-y:auto;display:none;' class='streeText inputLable' data-val='3'></div><div class='form-group'><label class='control-label col-xs-3 ' for='Intro'>介绍</label><div class='col-xs-9'><input class='form-control ' readonly='readonly' id='Intro' name='Intro' type='text' value='" +
            global.uIntro +
            "' /></div></div><div class='form-group'><label class='control-label col-xs-3 ' for='State'>说明</label><div class='col-xs-9'><input class='form-control ' readonly='readonly' id='State' name='State' type='text' value='" +
            global.uState +
            "' /></div></div><div class='form-group'><div id='allmap' style='height:300px;'></div></div>";
        $('#formBody').html(html);




        function createMap() {
            var map = new BMap.Map("allmap");
            var geoc = new BMap.Geocoder(); //地址解析对象  
            var markersArray = [];
            var long_lat=global.latBai.split(',');
            var long=long_lat[1];
            var lat=long_lat[0];
            if(lat>60){
                var long=long_lat[0]
                var lat=long_lat[1]
            }else{
                var long=long_lat[1];
                var lat=long_lat[0];
            }
            var geolocation = new BMap.Geolocation();
            var point = new BMap.Point(long, lat);
            console.log(point)
            map.centerAndZoom(point, 20); // 中心点  
            map.enableScrollWheelZoom(true);
            var mk = new BMap.Marker(point);
            map.addOverlay(mk);
            map.addEventListener("click", showInfo);
            //清除标识  
            function clearOverlays() {
                if (markersArray) {
                    for (var i in markersArray) {
                        map.removeOverlay(markersArray[i])
                    }
                }
            }
            //地图上标注  
            function addMarker(point) {
                var marker = new BMap.Marker(point);
                markersArray.push(marker);
                clearOverlays();
                map.addOverlay(marker);
            }
            //点击地图时间处理  
            function showInfo(e) {
                map.clearOverlays();
                geoc.getLocation(e.point, function (rs) {
                    console.log(rs)
                    var addComp = rs.addressComponents;
                    var address = addComp.province + addComp.city + addComp.district + addComp.street + addComp
                        .streetNumber;
                    console.log(address)
                    var bai_lg = e.point.lng + ',' +e.point.lat
                    console.log(bai_lg)
                    sessionStorage.setItem('bai_lg', bai_lg)
                    // document.getElementById('lng').value = e.point.lng;  
                    // document.getElementById('lat').value =  e.point.lat; 
                    document.getElementById('address').value = address;
                    var key = "16e7b5568d36fe3ae4fb17a2deba37b0";
                    $.ajax({
                        type: 'get',
                        url: 'https://restapi.amap.com/v3/geocode/geo',
                        data: 'key=' + key + '&address=' + address,
                        error: function (error) {
                            console.log(error)
                        },
                        success: function (result) {
                            console.log(result);
                            var gao_lat = result.geocodes[0].location;
                            sessionStorage.setItem('gao_lat', gao_lat);
                        }
                    })
                });
                addMarker(e.point);
            }
            var localSearch = new BMap.LocalSearch(map);
            localSearch.enableAutoViewport(); //允许自动调节窗体大小
            function searchByStationName() {
                map.clearOverlays(); //清空原来的标注
                var keyword = document.getElementById("address").value;
                console.log(keyword);
                var key = "16e7b5568d36fe3ae4fb17a2deba37b0";
                $.ajax({
                    type: 'get',
                    url: 'https://restapi.amap.com/v3/geocode/geo',
                    data: 'key=' + key + '&address=' + keyword,
                    error: function (error) {
                        console.log(error)
                    },
                    success: function (result) {
                        console.log(result);
                        var gao_lat = result.geocodes[0].location;
                        sessionStorage.setItem('gao_lat', gao_lat);
                        // var code = result.geocodes[0].adcode;
                        // sessionStorage.setItem('code', code);
                    }
                })
                //setSearchCompleteCallback--->设置检索结束后的回调函数
                localSearch.setSearchCompleteCallback(function (searchResult) {
                    console.log(searchResult)
                    var poi = searchResult.getPoi(0); 
                    // searchResult.Ar 数组中的第一个
                    // var longBai=poi.point.lng+','+poi.point.lat
                    // console.log('longBai-->'+longBai)
                    var bai_lg = poi.point.lng + ',' +poi.point.lat
                    console.log(bai_lg)
                    sessionStorage.setItem('bai_lg', bai_lg)
                    // document.getElementById("lng").value = poi.point.lng 
                    // document.getElementById("lat").value= poi.point.lat;
                    map.centerAndZoom(poi.point, 20);
                    var marker = new BMap.Marker(new BMap.Point(poi.point.lng, poi.point
                        .lat)); // 创建标注，为要查询的地方对应的经纬度
                    map.addOverlay(marker);
                });
                localSearch.search(keyword);
            }
            document.getElementById('r-result').onclick = function () {
                searchByStationName();
            }
        }
        createMap();

        function selectPro(state) {
            if (state == 0) {
                var fangVal = document.getElementById('UserName')
            } else if (state == 1) {
                var fangVal = document.getElementById('ResPeople')
            } else if (state == 2) {
                var fangVal = document.getElementById('gridmanname')
            } else {
                var fangVal = document.getElementById('streetCharge')
            }
            console.log(fangVal)
            fangVal.oninput = function () {
                var object = $(this).val();
                console.log(object)
                pro_num(state, object)
            }
        }

        function pro_num(state,object) { //0 防火员 1责任人
            console.log(state)
            $.ajax({
                tyle: 'get',
                url: url + '/getLegalFireMan.action',
                data: 'state=' + state + '&object=' + object,
                error: function (error) {
                    console.log(error + '网络错误')
                },
                success: function (result) {
                    var data = eval(result.mess);
                    console.log(data)
                    var html = "";
                    for (var i = 0; i < data.length; i++) {
                        html += "<li style='    margin-left: 135px;' value='" + data[i].user_name  + data[i].phone +
                            "' data-pid='" +
                            data[i].pid + "'>" + data[i].user_name + "" + data[i].phone + "</li>";
                    }
                    if (state == 0) {
                        $('.fangText').html(html);
                        var fangVal = document.getElementById('UserName')
                        var li = $('.fangText li');
                        console.log(li)
                    } else if(state=='1'){
                        $('.renText').html(html);
                        var fangVal = document.getElementById('ResPeople')
                        var li = $('.renText li');
                    }else if(state=='2'){
                        $('.wangText').html(html);
                        var fangVal = document.getElementById('gridmanname')
                        var li = $('.wangText li');
                    }else{
                        $('.streeText').html(html);
                        var fangVal = document.getElementById('streetCharge')
                        var li = $('.streeText li');
                    }
                    fangVal.oninput = function () {
                        var arr = fangVal.value;
                        if (arr != "" || arr != null) {
                            $.each(data, function (i, v) {
                                li[i].style.display = "none";
                                var rname = v.user_name;
                                var rphone = v.phone;
                                var rall = rname + rphone;
                                if (rname.indexOf(arr) != -1 || rphone.indexOf(arr) != -1 ||
                                    rall.indexOf(arr) != -1) {
                                    li[i].style.display = 'block'
                                } else {
                                    console.log(0)
                                }
                            })
                        }
                    }
                }
            })
        }

        $('.allList').click(function(){
            console.log($(this));
            var type=$(this).attr('data-val')
            console.log(type)
            if(type=='0'){
                $('.fangText').toggle();
            }else if(type=='1'){
                $('.renText').toggle();
            }else if(type=='2'){
                $('.wangText').toggle();   
            }else{
                $('.streeText').toggle();
            }
            selectPro(type);
            pro_num(type,'')
        })
        $('.inputLable').on('click', 'li', function () {
            var type = $(this).parent().attr('data-val')
            console.log(type)
            var dataVal = $(this).html() //
                var pid = $(this).attr('data-pid')
                var val = $(this).attr('value')
            if (type == '0') {
                $('#UserName').val(dataVal)
                $('#UserName').attr('data-pid', pid)
                $('#UserName').attr('value', val)
                $('.fangText').hide()
            } else if (type == '1') {
                $('#ResPeople').val(dataVal)
                $('#ResPeople').attr('data-pid', pid)
                $('#ResPeople').attr('value', val)
                $('.renText').hide()
            } else if (type == '2') {
                $('#gridmanname').val(val)
                $('#gridmanname').attr('data-pid', pid)
                $('#gridmanname').attr('value', val)
                $('.wangText').hide()
            } else {
                $('#streetCharge').val(val)
                $('#streetCharge').attr('data-pid', pid)
                $('#streetCharge').attr('value', val)
                $('.streeText').hide()
            }
        })

        $('#btn_close').click(function () {
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
        })


        //点击编辑保存
        $('#Edit_save').click(function () {
            console.log(global);
            var pid = global.pid;
            var projName = $('#ComName').val()
            var projLocation = $('#address').val();
            var fang = $('#UserName').val();
            var userName = fang.slice(0, -11); //防火员姓名
            var userTel = fang.slice(-11); //防火员手机号
            var res = $('#ResPeople').val()
            console.log(res);
            var resPeople = res.slice(0, -11); //负责人姓名
            var resTel = res.slice(-11); //负责人手机号
            console.log(resPeople)
            console.log(resTel)

            var grid = $('#gridmanname').val()
            var gridmanname = grid.slice(0, -11); //负责人姓名
            var gridman = grid.slice(-11); //负责人手机号
            var stree = $('#streetCharge').val()
            var street_chargenanem = stree.slice(0, -11); //负责人姓名
            var street_charge = stree.slice(-11); //负责人手机号
            var userType = "";
            var resType = "";
            var long_lat=sessionStorage.getItem('gao_lat') || global.long_lat;
            var longbai=sessionStorage.getItem('bai_lg') || global.latBai
            $.ajax({
                type: 'get',
                url: url + '/admin/project/check/newUpdateProjectSim.action',
                data: 'pid=' + pid + '&projLocation=' + projLocation + '&userName=' + userName +
                    '&userTel=' + userTel + '&resPeople=' + resPeople + '&resTel=' + resTel + '&long_lat=' +  long_lat +'&projName='+ projName+ '&gridmanname=' +  gridmanname +'&gridman='+ gridman+ '&street_chargenanem=' +  street_chargenanem +'&street_charge='+ street_charge +'&long_latbai='+ longbai,
                error: function (error) {
                    console.log(error + '网络错误Compile.html')
                },
                success: function (result) {
                    console.log(result)
                    if (result.status == 'true') {
                        alert(result.mess);
                        var index = parent.layer.getFrameIndex(window.name);
                        setTimeout(() => {
                            parent.layer.close(index);
                            // parent.location.reload();  //父级刷新
                            parent.location.reload(); //父级刷新
                        }, 100);
                    } else {
                        alert(result.mess);
                    }

                }
            })
        })
    </script>

</body>

</html>